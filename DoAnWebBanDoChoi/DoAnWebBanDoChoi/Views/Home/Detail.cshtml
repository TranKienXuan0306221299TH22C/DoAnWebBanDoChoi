@model DoAnWebBanDoChoi.ViewModels.ChiTietSanPhamVM
@using X.PagedList
@using X.PagedList.Mvc.Core

@{
    var daDangNhap = Context.Session.GetString("DangNhap") == "true";
    ViewData["Title"] = "Chi tiết";
}
<!-- Product Details Section Begin -->
<section class="product-details spad">
    <div class="container">
        <div class="row">
            <div class="col-lg-6 col-md-6">
                <div class="product__details__pic">
                    <div class="product__details__pic__item">
                        <img class="product__details__pic__item--large"
                        src="@Url.Content("~/img/product/dochoi/" + @Model.SanPham.HinhAnh)" alt="" >
                    </div>

                </div>
            </div>
            <div class="col-lg-6 col-md-6">
                <div class="product__details__text">
                    <h3>@Model.SanPham.TenSanPham</h3>
                   
                    @* ✨ Hiển thị số sao  *@
                    <div class="product__details__rating">
                        @{
                            double diemTB = Model.DiemSaoTrungBinh;
                            int soSaoDay = (int)Math.Floor(diemTB);
                            bool coNuaSao = (diemTB - soSaoDay) >= 0.5;
                            int soSaoTrong = 5 - soSaoDay - (coNuaSao ? 1 : 0);

                            for (int i = 0; i < soSaoDay; i++)
                            {
                                <i class="fa fa-star"></i>
                            }
                            if (coNuaSao)
                            {
                                <i class="fa fa-star-half-o"></i>
                            }

                            for (int i = 0; i < soSaoTrong; i++)
                            {
                                <i class="fa fa-star-o" style="color: #ccc;"></i>
                            }
                            string reviewText = Model.BinhLuans.TotalItemCount == 0 ? "Chưa có đánh giá" : $"({Model.BinhLuans.TotalItemCount} Đánh giá)";
                            <span class="ml-2">@diemTB.ToString("0.0") / 5</span>
                            <span>@reviewText</span>
                        }
                    </div>
                    @* Kết thúc phần Hiển thị số sao *@
                    <div class="product__details__price">@Model.SanPham.DonGia.ToString("N0") đ</div>
                    @* <pre> @Model.SanPham.MoTa</pre> *@
                       
                    
             
                    <div class="product__details__quantity">
                        <div class="quantity">
                            <div class="pro-qty">
                                <input type="number" class="soLuongInput" value="1" min="1" />
                            </div>
                        </div>
                    </div>
              

 
                    @if (daDangNhap)
                    {
                        <button onclick="themChiTietGio(@Model.SanPham.MaSp)" class="primary-btn">Thêm vào giỏ hàng</button>
                    }
                    else
                    {

                        <button onclick="xacNhanDangNhap()" class="primary-btn">Thêm vào giỏ hàng</button>

                    } 
                

                    <ul>
                        <li><b>Thương hiệu</b> <span>@Model.SanPham.MaThNavigation.TenThuongHieu</span></li>

                        <li><b>Danh mục</b> <span>@Model.SanPham.MaDmNavigation.TenDanhMuc</span></li>
                        <li>
                            <b>Share on</b>
                            <div class="share">
                                <a href="#"><i class="fa fa-facebook"></i></a>
                                <a href="#"><i class="fa fa-twitter"></i></a>
                                <a href="#"><i class="fa fa-instagram"></i></a>
                                <a href="#"><i class="fa fa-pinterest"></i></a>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>

            <div style="white-space: pre-wrap; font-size: 1.2em;">
                <h3>Mô tả:</h3>  @Model.SanPham.MoTa
            </div>

            <div class="product-details-container">
                <h2 class="product-details-heading">Chi Tiết Sản Phẩm</h2>

                <table class="table table-bordered product-details-table" style="font-size: 1.2em;">
                    <tbody>
                        <tr>
                            <td class="detail-label fw-bold" style="width: 200px;">Tên sản phẩm</td>
                            <td class="detail-value">@(Model.SanPham.TenSanPham ?? "")</td>
                        </tr>
                        <tr>
                            <td class="detail-label fw-bold" style="width: 200px;">Thương hiệu</td>
                            <td class="detail-value">@(Model.SanPham.MaThNavigation?.TenThuongHieu ?? "")</td>
                        </tr>

                        <tr>
                            <td class="detail-label fw-bold">Kích thước (Dài x Rộng x Cao)</td>
                            <td class="detail-value">@(Model.SanPham.KichThuoc ?? "")</td>
                        </tr>
                        <tr>
                            <td class="detail-label fw-bold">Chất liệu</td>
                            <td class="detail-value">@(Model.SanPham.ChatLieu ?? "")</td>
                        </tr>
                        <tr>
                            <td class="detail-label fw-bold">Độ tuổi phù hợp</td>
                            <td class="detail-value">@(Model.SanPham.DoTuoiPhuHop ?? "")</td>
                        </tr>
                        <tr>
                            <td class="detail-label fw-bold">Trọng lượng sản phẩm</td>
                            <td class="detail-value">@(Model.SanPham.TrongLuong ?? "")</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="col-lg-12">
                <div class="bg-light p-3 rounded mb-4 mt-4">
                    <h5 class="fw-bold text-dark text-center">— Đánh giá sản phẩm —</h5>
                    <!-- Bình luận 1 -->
                    @foreach (var bl in Model.BinhLuans)
                    {
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex align-items-start" style="gap: 12px;">
                                    <img src="@Url.Content("~/img/profile/" + bl.MaNdNavigation.HinhAnh)"
                                         class="rounded-circle me-3" alt="Avatar" style="width: 60px; height: 60px; object-fit: cover;">
                                    <div>
                                        <h6 class="mb-0 fw-bold">@bl.MaNdNavigation.TenDangNhap</h6>
                                        <small class="text-muted">@bl.NgayTao.ToString("dd/MM/yyyy HH:mm")</small>

                                        <div class="text-warning mb-2">
                                            @for (int i = 1; i <= 5; i++)
                                            {
                                                if (i <= bl.Diem)
                                                {
                                                    <i class="fa fa-star"></i>
                                                }
                                                else
                                                {
                                                    <i class="fa fa-star-o"></i>
                                                }
                                            }
                                        </div>

                                        <p class="mb-1">@bl.NoiDungBinhLuan</p>

                                        @if (!string.IsNullOrEmpty(bl.PhanHoiBinhLuan))
                                        {
                                            <div class="bg-light p-2 rounded">
                                                <strong>Phản hồi của người bán:</strong><br />
                                                @bl.PhanHoiBinhLuan
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    


                </div>
                <div class="text-center">
                    @Html.PagedListPager(Model.BinhLuans, page => Url.Action("Detail", new { slug = Model.SanPham.Slug, id = Model.SanPham.MaSp, page }),
                    new PagedListRenderOptions
                    {
                      
                        DisplayLinkToFirstPage = PagedListDisplayMode.Always,
                        DisplayLinkToLastPage = PagedListDisplayMode.Always,
                        DisplayLinkToPreviousPage = PagedListDisplayMode.Always,
                        DisplayLinkToNextPage = PagedListDisplayMode.Always,
                        MaximumPageNumbersToDisplay = 5, 

                        
                        UlElementClasses = new[] { "pagination", "justify-content-center", "mt-3" }, 
                        LiElementClasses = new[] { "page-item" },
                        PageClasses = new[] { "page-link" }, 

                        
                        ActiveLiElementClass = "active", 


                        LinkToFirstPageFormat = "<< Trang đầu",
                        LinkToLastPageFormat = "Trang cuối >>",
                        LinkToPreviousPageFormat = "Trước",
                        LinkToNextPageFormat = "Sau"
                    })
                </div>

            </div>
        </div>
    </div>
</section>

<!-- Product Details Section End -->
<!-- Related Product Section Begin -->
<section class="related-product">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="section-title related__product__title">
                    <h2>Sản phẩm liên quan</h2>
                </div>
            </div>
        </div>

        <div class="row">
            @foreach (var sp in Model.SanPhamLienQuan)
            {
                <div class="col-lg-3 col-md-4 col-sm-6">
                    <div class="product__item">

                        <div class="product__item__pic set-bg">
                            <a asp-controller="Home" asp-action="Detail"
                               asp-route-slug="@sp.Slug" asp-route-id="@sp.MaSp">
                                <img src="@(Url.Content("~/img/product/dochoi/" + sp.HinhAnh))"
                                     alt="@sp.TenSanPham" class="product__item__pic" />
                            </a>
                            <ul class="product__item__pic__hover">
                                <li>

                                    @if (daDangNhap)
                                    {
                                        <a href="javascript:;" class="btn-yeu-thich" data-id="@sp.MaSp">
                                            <i class="fa fa-heart "></i>
                                        </a>
                                    }
                                    else
                                    {
                                        <a href="javascript:;" onclick="xacNhanDangNhap()">
                                            <i class="fa fa-heart"></i>
                                        </a>
                                    }

                                </li>

                                <li>
                                    @if (daDangNhap)
                                    {
                                        <a href="javascript:;" onclick="submitThemGio(@sp.MaSp)">
                                            <i class="fa fa-shopping-cart"></i>
                                        </a>
                                    }
                                    else
                                    {
                                        <a href="javascript:;" onclick="xacNhanDangNhap()">
                                            <i class="fa fa-shopping-cart"></i>
                                        </a>
                                    }
                                </li>
                            </ul>
                        </div>
                        <div class="product__item__text">
                            <h6><a asp-controller="Home" asp-action="Detail" asp-route-slug="@sp.Slug" asp-route-id="@sp.MaSp">@sp.TenSanPham</a></h6>
                            <h5>@sp.DonGia.ToString("N0") đ</h5>
                        </div>
                    </div>
                </div>
            }


        </div>
    </div>
</section>
<!-- Related Product Section End -->
@section Scripts {
    <script>
        $(document).ready(function () {
            // ✅ Gọi lại là được vì hàm đã có trong site.js
            capNhatSoLuongGioHang();

            $('.soLuongInput').on('change blur input', function () {
                var val = parseInt($(this).val());
                if (isNaN(val) || val < 1) {
                    $(this).val(1);
                }
            });
        });

        function themChiTietGio(maSp) {
            var soLuong = parseInt($('.soLuongInput').val()) || 1;

            $.ajax({
                url: '/Cart/ThemVaoGio',
                type: 'POST',
                data: {
                    maSp: maSp,
                    soLuong: soLuong
                },
                success: function (res) {
                    if (res.success) {
                        $('#gioHangSoLuong').text(res.soLuong);
                        alert('Đã thêm vào giỏ hàng!');
                    } else {
                        alert('Lỗi: ' + res.message);
                    }
                },
                error: function () {
                    alert('Có lỗi xảy ra khi thêm sản phẩm!');
                }
            });
        }
    </script>
}

