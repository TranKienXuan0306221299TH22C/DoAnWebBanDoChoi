@model List<DoAnWebBanDoChoi.ViewModels.Admin.PhanHoiVM>
@{
    ViewData["Title"] = "Quản lý Liên hệ/Phản hồi";
    
    // Đảm bảo các hàng được phân loại
    var chuaXem = Model.Where(ph => !ph.IsRead).ToList();
    var daXem = Model.Where(ph => ph.IsRead).ToList();
}


<div class="container-fluid pt-4 px-4">
    <div class="bg-white rounded shadow p-4 border">
        <h2>Quản Lý Phản Hồi Khách Hàng</h2>

        <hr />

        <ul class="nav nav-tabs" id="phanHoiTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="chua-xem-tab" data-bs-toggle="tab" data-bs-target="#chua-xem" type="button" role="tab" aria-controls="chua-xem" aria-selected="true">
                    Chưa Xem (@chuaXem.Count)
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="da-xem-tab" data-bs-toggle="tab" data-bs-target="#da-xem" type="button" role="tab" aria-controls="da-xem" aria-selected="false">
                    Đã Xem (@daXem.Count)
                </button>
            </li>
        </ul>

        <div class="tab-content" id="phanHoiTabsContent">

            <div class="tab-pane fade show active" id="chua-xem" role="tabpanel" aria-labelledby="chua-xem-tab">
                <br />

                @if (chuaXem.Any())
                {
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Khách hàng</th>
                                <th>Nội dung</th>
                                <th>Thời gian</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="chua-xem-body">
                            @foreach (var item in chuaXem)
                            {
                                <tr id="row-@item.MaPhanHoi">
                                    <td>@item.MaPhanHoi</td>
                                    <td>
                                        <strong>@item.HoTen</strong> <br />
                                        <small>@item.Email - @item.SoDienThoai</small>
                                    </td>
                                    <td>
                                        <a href="@Url.Action("ChiTiet", "Contact", new { id = item.MaPhanHoi })" class="text-decoration-none text-dark d-block content-preview">
                                            @if (!string.IsNullOrEmpty(item.TieuDe))
                                            {
                                                <b>@item.TieuDe</b> <span class="text-muted">- @item.NoiDung</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">@item.NoiDung</span>
                                            }
                                        </a>
                                    </td>
                                    <td>@item.ThoiGianGui.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td>
                                        <button class="btn btn-sm btn-info btn-mark-read" data-id="@item.MaPhanHoi">
                                            Đã xem
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <div class="alert alert-success">Không có phản hồi nào chưa được xem.</div>
                }
            </div>

            <div class="tab-pane fade" id="da-xem" role="tabpanel" aria-labelledby="da-xem-tab">
                <br />
                @if (daXem.Any())
                {
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Mã</th>
                                <th>Khách hàng</th>
                                <th>Nội dung</th>
                                <th>Thời gian</th>
                                <th>Thao tác</th> </tr>
                        </thead>
                        <tbody id="da-xem-body">
                            @foreach (var item in daXem)
                            {
                                <tr id="row-@item.MaPhanHoi-read" class="table-secondary">
                                    <td>@item.MaPhanHoi</td>
                                    <td>
                                        <strong>@item.HoTen</strong> <br />
                                        <small>@item.Email - @item.SoDienThoai</small>
                                    </td>
                                    <td>
                                        <a href="@Url.Action("ChiTiet", "Contact", new { id = item.MaPhanHoi })" class="text-decoration-none text-dark d-block content-preview">
                                            @if (!string.IsNullOrEmpty(item.TieuDe))
                                            {
                                                <b>@item.TieuDe</b> <span class="text-muted">- @item.NoiDung</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">@item.NoiDung</span>
                                            }
                                        </a>
                                    </td>
                                    <td>@item.ThoiGianGui.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td>
                                        <button class="btn btn-sm btn-warning btn-mark-unread" data-id="@item.MaPhanHoi">
                                            Chưa xem
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <div class="alert alert-warning">Chưa có phản hồi nào được đánh dấu là Đã xem.</div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Hàm hỗ trợ cập nhật số lượng trên Tab và Alert
            function updateTabCounts() {
                var chuaXemCount = $('#chua-xem-body tr').length;
                var daXemCount = $('#da-xem-body tr').length;

                // Cập nhật nội dung nút tab
                $('#chua-xem-tab').html('Chưa Xem (' + chuaXemCount + ')');
                $('#da-xem-tab').html('Đã Xem (' + daXemCount + ')');

                // Hiển thị/Ẩn thông báo "Không có phản hồi"
                if (chuaXemCount === 0) {
                    $('#chua-xem').find('.alert-success').show();
                    $('#chua-xem').find('table').hide(); // Ẩn bảng khi không có dữ liệu
                } else {
                    $('#chua-xem').find('.alert-success').hide();
                    $('#chua-xem').find('table').show();
                }

                if (daXemCount === 0) {
                    $('#da-xem').find('.alert-warning').show();
                    $('#da-xem').find('table').hide();
                } else {
                    $('#da-xem').find('.alert-warning').hide();
                    $('#da-xem').find('table').show();
                }
            }


            // Hàm xử lý chung việc chuyển trạng thái
            function handleMarkStatus(maPhanHoi, actionUrl, isRead, $row, $button, newButtonClass, newButtonText, targetBodyId, newRowIdSuffix, targetRowClass) {
                
                // Tắt nút để tránh click kép
                $button.prop('disabled', true).text('Đang chuyển...');

                var $newRow = $row.clone(); // Lấy đối tượng <tr> gốc và tạo bản sao

                $.ajax({
                    type: "POST",
                    url: actionUrl,
                    data: { id: maPhanHoi, isRead: isRead }, // Truyền trạng thái cần cập nhật

                    success: function (response) {
                        if (response.success) {

                            // 1. CHUẨN BỊ BẢN SAO CHO TAB ĐÍCH
                            // - Cập nhật ID mới và thêm/xóa class màu
                            $newRow.attr('id', 'row-' + maPhanHoi + newRowIdSuffix);
                            if (targetRowClass) {
                                $newRow.addClass(targetRowClass);
                            } else {
                                $newRow.removeClass('table-secondary'); // Xóa màu xám nếu chuyển sang Chưa xem
                            }
                            
                            // - Cập nhật lại nút thao tác (tạo nút mới cho bản sao)
                            var $newButton = $('<button class="btn btn-sm ' + newButtonClass + '"></button>')
                                .attr('data-id', maPhanHoi)
                                .text(newButtonText);
                            
                            // Gắn class xử lý sự kiện cho nút mới
                            if (isRead) {
                                // Nếu chuyển sang Đã xem, nút mới là "Chưa xem"
                                $newButton.addClass('btn-mark-unread');
                                // Xóa cột cuối cùng (cột Thao tác) cũ (Đã xem)
                                $newRow.find('td:last-child').html($newButton);
                            } else {
                                // Nếu chuyển sang Chưa xem, nút mới là "Đã xem"
                                $newButton.addClass('btn-mark-read');
                                // Cập nhật nội dung cột cuối cùng (cột Thao tác)
                                $newRow.find('td:last-child').html($newButton); 
                            }


                            // 2. CẬP NHẬT TAB ĐÍCH
                            $('#' + targetBodyId).prepend($newRow);

                            // 3. CẬP NHẬT TAB GỐC
                            $row.remove();

                            // 4. CẬP NHẬT SỐ LƯỢNG
                            updateTabCounts();

                        } else {
                            // Xử lý lỗi từ Server
                            alert('Lỗi: ' + (response.message || 'Không thể cập nhật trạng thái.'));
                            $button.prop('disabled', false).text(isRead ? 'Đã xem' : 'Chưa xem'); // Khôi phục nút
                        }
                    },
                    error: function () {
                        // Xử lý lỗi kết nối
                        alert("Lỗi kết nối server. Vui lòng thử lại.");
                        $button.prop('disabled', false).text(isRead ? 'Đã xem' : 'Chưa xem'); // Khôi phục nút
                    }
                });
            }

            // SỰ KIỆN: Click nút "Đánh dấu Đã xem" (Chuyển từ Chưa xem -> Đã xem)
            $(document).on('click', '.btn-mark-read', function () {
                var maPhanHoi = $(this).data('id');
                var $row = $('#row-' + maPhanHoi);
                var $button = $(this);
                
                // Tham số: maPhanHoi, actionUrl, isRead, $row, $button, newButtonClass, newButtonText, targetBodyId, newRowIdSuffix, targetRowClass
                handleMarkStatus(maPhanHoi, "/Admin/Contact/MarkAsReadUnread", true, $row, $button, 'btn-warning', 'Chưa xem', 'da-xem-body', '-read', 'table-secondary');
            });

            // SỰ KIỆN: Click nút "Đánh dấu Chưa xem" (Chuyển từ Đã xem -> Chưa xem)
            $(document).on('click', '.btn-mark-unread', function () {
                var maPhanHoi = $(this).data('id');
                var $row = $('#row-' + maPhanHoi + '-read'); // ID có suffix -read
                var $button = $(this);
                
                // Tham số: maPhanHoi, actionUrl, isRead, $row, $button, newButtonClass, newButtonText, targetBodyId, newRowIdSuffix, targetRowClass
                handleMarkStatus(maPhanHoi, "/Admin/Contact/MarkAsReadUnread", false, $row, $button, 'btn-info', 'Đã xem', 'chua-xem-body', '', null); // Không có suffix và không có class màu cho tab Chưa xem
            });


            // Gọi lần đầu để đảm bảo count và alert hiển thị đúng
            updateTabCounts();
        });
    </script>
}