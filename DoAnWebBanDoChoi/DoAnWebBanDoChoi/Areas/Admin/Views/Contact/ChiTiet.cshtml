@model DoAnWebBanDoChoi.ViewModels.Admin.PhanHoiVM
@{
    ViewData["Title"] = "Chi Tiết Phản Hồi #" + Model.MaPhanHoi;
}

<div class="container-fluid pt-4 px-4">
    <div class="bg-white rounded shadow p-4 border">

        <h2>Chi Tiết Phản Hồi</h2>
        <hr />

        <div class="mb-3">
            <a href="@Url.Action("LienHe", "Contact")" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Quay lại Danh sách
            </a>

            @if (Model.IsRead)
            {
                <button class="btn btn-warning btn-sm float-end btn-status-toggle" data-id="@Model.MaPhanHoi" data-isread="true">
                    Đánh dấu Chưa xem
                </button>
            }
            else
            {
                <button class="btn btn-info btn-sm float-end btn-status-toggle" data-id="@Model.MaPhanHoi" data-isread="false">
                    Đánh dấu Đã xem
                </button>
            }
        </div>

        <div class="card p-4">
            <h4 class="card-title text-primary mb-3">@Model.TieuDe</h4>

            <p class="card-text">
                <i class="fas fa-user"></i> <strong>Khách hàng:</strong> @Model.HoTen
            </p>
            <p class="card-text">
                <i class="fas fa-envelope"></i> <strong>Email:</strong> <a href="mailto:@Model.Email">@Model.Email</a>
            </p>
            <p class="card-text">
                <i class="fas fa-phone"></i> <strong>Điện thoại:</strong> @Model.SoDienThoai
            </p>
            <p class="card-text">
                <i class="fas fa-clock"></i> <strong>Thời gian gửi:</strong> @Model.ThoiGianGui.ToString("dd/MM/yyyy HH:mm:ss")
            </p>

            <hr />

            <h5>Nội dung Phản hồi:</h5>
            <div class="border p-3 bg-light rounded" style="white-space: pre-wrap;">
                @Model.NoiDung
            </div>
        </div>

        <div class="mt-3">
            <a href="@Url.Action("LienHe", "Contact")" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Quay lại Danh sách
            </a>
        </div>

    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Sự kiện click nút "Đánh dấu Đã xem/Chưa xem" trong view Chi Tiết
            $('.btn-status-toggle').click(function () {
                var maPhanHoi = $(this).data('id');
                var currentIsRead = $(this).data('isread'); // Trạng thái hiện tại
                var newIsRead = !currentIsRead; // Trạng thái cần chuyển đến
                var $button = $(this);

                $button.prop('disabled', true);

                $.ajax({
                    type: "POST",
                    url: "/Admin/Contact/MarkAsReadUnread",
                    data: { id: maPhanHoi, isRead: newIsRead },

                    success: function (response) {
                        if (response.success) {
                            // Cập nhật giao diện nút
                            $button.removeClass('btn-info btn-warning');
                            $button.data('isread', newIsRead); // Cập nhật trạng thái data

                            if (newIsRead) {
                                $button.addClass('btn-warning').text('Đánh dấu Chưa xem');
                                alert('Đã đánh dấu phản hồi là Đã xem.');
                            } else {
                                $button.addClass('btn-info').text('Đánh dấu Đã xem');
                                alert('Đã đánh dấu phản hồi là Chưa xem.');
                            }

                            $button.prop('disabled', false);

                        } else {
                            alert('Lỗi: ' + (response.message || 'Không thể cập nhật trạng thái.'));
                            $button.prop('disabled', false);
                        }
                    },
                    error: function () {
                        alert("Lỗi kết nối server. Vui lòng thử lại.");
                        $button.prop('disabled', false);
                    }
                });
            });
        });
    </script>
}