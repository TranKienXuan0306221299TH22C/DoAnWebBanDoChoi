@model X.PagedList.IPagedList<DoAnWebBanDoChoi.Models.SanPham> 
@using X.PagedList.Mvc.Core 


@{
    ViewData["Title"] = "Danh sách sản phẩm";
    var danhMucs = ViewBag.DanhMucs;
    string search = ViewBag.CurrentSearch as string ?? "";
    int? currentDanhMuc = ViewBag.CurrentDanhMuc as int?;
    int currentPage = ViewBag.CurrentPage as int? ?? 1; 
}

<div class="container-fluid pt-4 px-4">
    <div class="bg-white rounded shadow p-4 border">

        <div class="d-flex justify-content-between mb-4">
            <h5 class="text-primary fw-bold">Danh sách sản phẩm</h5>
            <a asp-action="Create" class="btn btn-success btn-sm">
                <i class="fa fa-plus me-1"></i> Thêm sản phẩm
            </a>
        </div>

        <form method="get" asp-action="SanPham" class="row g-2 mb-4">
            <div class="col-md-4">
                <input type="text" name="search" class="form-control" placeholder="Tìm theo tên sản phẩm..." value="@search" />
            </div>
            <div class="col-md-3">
                <select name="maDm" class="form-select">
                    <option value="">-- Chọn danh mục --</option>
                        @foreach (var dm in danhMucs)
                    {
                        var danhsach = (currentDanhMuc == dm.MaDm) ? "selected" : "";
                        @:<option value="@dm.MaDm" @danhsach>@dm.TenDanhMuc</option>
                    }

                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">Tìm kiếm</button>
            </div>
            <div class="col-md-2">
                <a asp-action="SanPham" class="btn btn-warning w-100">Hiện tất cả</a>
            </div>
            
            <input type="hidden" name="page" value="@currentPage" />
        </form>


        <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle ">
                <thead class="table-primary text-center sticky-top text-nowrap" style="top: 0; z-index: 1;">
                    <tr>
                        <th>#</th>
                        <th>Tên</th>
                        <th>Ảnh</th>
                        <th>Mô tả</th>
                        <th>Chất liệu</th>
                        <th>Kích thước</th>
                        <th>Độ tuổi</th>
                        <th>Trọng lượng</th>
                        <th>Danh mục</th>
                        <th>Thương hiệu</th>
                        <th>Nhà cung cấp</th>
                        <th>Giá gốc</th>
                        <th>Giá bán</th>
                        <th>Số lượng</th>
                        <th>Trạng thái</th>
                        <th>Ngày tạo</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                   
                    @foreach (var sp in Model)
                    {
                        <tr>
                            <td class="text-center">@sp.MaSp</td>
                            <td style="min-width:200px;">@sp.TenSanPham</td>
                            <td>
                                @if (!string.IsNullOrEmpty(sp.HinhAnh))
                                {
                                    <img src="~/img/product/dochoi/@sp.HinhAnh" width="60" />
                                }
                            </td>
                            <td title="@sp.MoTa">
                                <div class="text-limit-2-line">@sp.MoTa</div>
                            </td>
                            <td class="text-nowrap">@sp.ChatLieu</td>
                            <td class="text-nowrap">@sp.KichThuoc</td>
                            <td class="text-nowrap">@sp.DoTuoiPhuHop</td>
                            <td class="text-nowrap">@sp.TrongLuong</td>
                            <td class="">@sp.MaDmNavigation?.TenDanhMuc</td>
                            <td class="text-nowrap">@sp.MaThNavigation?.TenThuongHieu</td>
                            <td style="min-width:200px;">@sp.MaNccNavigation?.TenNhaCungCap</td>
                            <td class="text-end text-nowrap">@sp.GiaGoc.ToString("N0") đ</td>
                            <td class="text-end text-nowrap">@sp.DonGia.ToString("N0") đ</td>
                            <td class="text-center">@sp.SoLuong</td>
                            <td class="text-center text-nowrap">
                                @(sp.TrangThai == 1 ? "Hoạt động" : "Ngừng bán")
                            </td>
                            <td class="text-center text-nowrap">@sp.NgayTao.ToString("dd/MM/yyyy")</td>
                            <td class="text-center text-nowrap">
                                <a asp-action="Edit" asp-route-id="@sp.MaSp" class="btn btn-sm btn-warning">
                                    <i class="fa fa-edit"></i>
                                </a>
                                <button type="button" class="btn btn-sm @(sp.TrangThai == 1 ? "btn-danger" : "btn-success") toggle-status-btn"
                                        data-id="@sp.MaSp">
                                    <i class="fa fa-power-off"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        
        <div class="d-flex justify-content-center mt-4">
            @Html.PagedListPager(Model, page => Url.Action("SanPham", new { page = page, search = search, maDm = currentDanhMuc }),
                new PagedListRenderOptions
                  {
                            UlElementClasses = new[] { "pagination", "justify-content-center" },
                            LiElementClasses = new[] { "page-item" },
                            PageClasses = new[] { "page-link" },
                            ActiveLiElementClass = "active"
                        }
            )
        </div>
       
        
    </div>
</div>


@section Scripts {
   
    <script>
        $(document).ready(function () {
            $(".toggle-status-btn").click(function () {
                var button = $(this);
                var id = button.data("id");

                Swal.fire({
                    title: 'Xác nhận',
                    text: "Bạn có chắc muốn đổi trạng thái sản phẩm?",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Đồng ý',
                    cancelButtonText: 'Hủy'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: '/Admin/Product/ToggleStatusAjax',
                            method: 'POST',
                            data: { id: id },
                            success: function (res) {
                             if (res.success) {
                                if (res.newStatus === 1) {
                                    button.removeClass("btn-success").addClass("btn-danger");
                                    button.closest("tr").find("td:eq(9)").text("Hoạt động");
                                } else {
                                    button.removeClass("btn-danger").addClass("btn-success");
                                    button.closest("tr").find("td:eq(9)").text("Ngừng bán");
                                }

                                showTempAlert('success', 'Đã cập nhật trạng thái sản phẩm!');
                            } else {
                                showTempAlert('error', res.message || 'Cập nhật thất bại!');
                            }
                            },
                            error: function () {
                                $("#temp-error-msg").val("Lỗi kết nối server!");
                                showTempAlert();
                            }
                        });
                    }
                });
            });
        });
    </script>
}
